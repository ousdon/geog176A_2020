---
title: "lab5"
author: "Xingxin Li"
date: "9/4/2020"
output: html_document
---

``````{r, message = FALSE, warning = FALSE}
library(raster) 
library(tidyverse)  
library(getlandsat)  
library(sf)  
library(mapview)
library(osmdata)
library(getlandsat)
library(leaflet)
```

``````{r, message = FALSE, warning = FALSE}
#Find AOI
#Q1.1

bb = read.csv("/Users/xingxin/Github/geog176a-summer-2020-lab1/uscities.csv") %>%
  filter(city == "Palo") %>%
  st_as_sf(coords = c("lng","lat"), crs = 4326) %>%
  st_transform(5070) %>%
  st_buffer(5000) %>%
  st_bbox() %>%
  st_as_sfc() %>%
  st_as_sf()

mapview(bb)
```

``````{r, message = FALSE, warning = FALSE}
#OSM Example
#Q1.2

bwgs = st_transform(bb, 4326)

osm = osmdata::opq(bwgs) %>% 
 osmdata::add_osm_feature("building") %>% 
  osmdata::osmdata_sf()
 
mapview(osm$osm_polygons)
```

```{r, message = FALSE, warning = FALSE}
#landset discovery space and time
#Q2.1

bbwgs = bb %>% st_transform(4326)

bb = st_bbox(bbwgs)

scenes = lsat_scenes()

down = scenes %>%
  filter(min_lat <= bb$ymin, max_lat >= bb$ymax,
         min_lon <= bb$xmin, max_lon >= bb$xmax,
         as.Date(acquisitionDate) == as.Date("2016-09-26"))

write.csv(down, file = "/Users/xingxin/Github/geog176a-summer-2020-lab1/palo-flood-scene.csv")
```

```{r, message = FALSE, warning = FALSE}
#Q2.2-2.3

meta = read_csv("/Users/xingxin/Github/geog176a-summer-2020-lab1/palo-flood-scene.csv")

files = lsat_scene_files(meta$download_url) %>%
  filter(grepl(paste0("B", 1:6, ".TIF$", collapse = "|"), file)) %>%
  arrange(file) %>%
  pull(file)

st = sapply(files, lsat_image)

s = stack(st) %>% 
  setNames(c(paste0("band", 1:6)))

cropper = bbwgs %>% 
  st_transform(crs(s)) 

r = crop(s, cropper)

```


```{r, message = FALSE, warning = FALSE}
#Q3 plotting

par(mfrow = c(2,2))
plotRGB(r, r = 4, g = 2, b = 2, stretch = "lin")
plotRGB(r, r = 5, g = 4, b = 3, stretch = "hist")
plotRGB(r, r = 6, g = 5, b = 4, stretch = "hist")
dev.off()
```


```{r, message = FALSE, warning = FALSE}
#Q4.1 Local Operation

#ndvi
ndvi = (r$band5 - r$band4) / (r$band5 + r$band4)
plot(ndvi)

palette1 = colorRampPalette(c("blue", "white", "red"))
plot(ndvi, col = palette1(256))

#ndwi
ndwi = (r$band3 - r$band5) / (r$band3 + r$band5)
plot(ndvi)

palette2 = colorRampPalette(c("blue", "white", "red"))
plot(ndwi, col = palette2(256))

#mndvi
mndvi = (r$band3 - r$band6) / (r$band3 + r$band6)
plot(mndvi)

palette3 = colorRampPalette(c("blue", "white", "red"))
plot(mndvi, col = palette3(256))

#wri
wri = (r$band3 + r$band4) / (r$band5 + r$band4)
plot(wri)

palette4 = colorRampPalette(c("blue", "white", "red"))
plot(wri, col = palette4(256))

#swi
swi = 1 / sqrt(r$band2 - r$band6)
plot(swi)

palette5 = colorRampPalette(c("blue", "white", "red"))
plot(ndvi, col = palette5(256))
```

```{r, message = FALSE, warning = FALSE}
#Q4.2 Thresholding

thresholding = function(x){ifelse(x <= 0, 1, NA)}

thresholding(100)
thresholding(-100)

flood = calc(ndvi, thresholding)
plot(flood, col = "blue")

mapview(flood)

```
